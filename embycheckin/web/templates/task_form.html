{% extends "base.html" %}

{% block header_title %}{{ '编辑任务' if task else '新建任务' }}{% endblock %}

{% block title %}{{ '编辑任务' if task else '新建任务' }} - EmbyCheckin{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="taskForm()">
    
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h3 class="text-xl font-bold text-gray-800">{{ '编辑任务' if task else '新建任务' }}</h3>
            <p class="text-sm text-gray-500">配置定时任务的基本信息和执行参数</p>
        </div>
        <a href="/" class="text-gray-500 hover:text-gray-700 font-medium text-sm flex items-center">
            <i class="ri-close-circle-line text-lg mr-1"></i>取消
        </a>
    </div>

    <form @submit.prevent="submitForm" class="space-y-6">
        
        <!-- 基础配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-settings-3-line mr-2 text-indigo-500"></i>基础配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">任务名称</label>
                    <input type="text" x-model="form.name" required
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="例如：Emby 每日签到">
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">任务类型</label>
                    <select x-model="form.type" required :disabled="isEdit"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                        {% for t in task_types %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">关联账号</label>
                    <select x-model="form.account_id" required
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                        <option value="">-- 选择账号 --</option>
                        {% for acc in accounts %}
                        <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.session_name }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">目标对象 (Bot/Chat)</label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">@</span>
                        </div>
                        <input type="text" x-model="form.target" required
                            class="w-full pl-7 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                            placeholder="EmbyPublicBot">
                    </div>
                </div>
            </div>
        </div>

        <!-- 调度配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-time-line mr-2 text-indigo-500"></i>调度配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-6 gap-6">
                <div class="col-span-1 md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cron 表达式</label>
                    <input type="text" x-model="form.schedule_cron" required
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5 font-mono"
                        placeholder="0 9 * * *">
                    <p class="mt-1 text-xs text-gray-500">分 时 日 月 周 (例: 0 9 * * * 表示每天9点)</p>
                </div>

                <div class="col-span-1 md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">快捷选择</label>
                    <select @change="if($event.target.value) form.schedule_cron = $event.target.value"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                        <option value="">-- 选择预设 --</option>
                        <option value="0 8 * * *">每天 8:00</option>
                        <option value="0 9 * * *">每天 9:00</option>
                        <option value="0 10 * * *">每天 10:00</option>
                        <option value="0 12 * * *">每天 12:00</option>
                        <option value="0 18 * * *">每天 18:00</option>
                        <option value="0 22 * * *">每天 22:00</option>
                        <option value="0 */6 * * *">每6小时</option>
                        <option value="0 9 * * 1-5">工作日 9:00</option>
                    </select>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">时区</label>
                    <input type="text" x-model="form.timezone"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">重试次数</label>
                    <input type="number" x-model.number="form.retries" min="0"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">随机延迟 (秒)</label>
                    <input type="number" x-model.number="form.jitter_seconds" min="0"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
            </div>
        </div>

        <!-- Bot Checkin Config -->
        <div x-show="form.type === 'bot_checkin'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-robot-line mr-2 text-indigo-500"></i>机器人签到配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">签到命令</label>
                    <input type="text" x-model="params.bot_checkin.command"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="/checkin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">响应超时 (秒)</label>
                    <input type="number" x-model.number="params.bot_checkin.timeout"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                
                <div class="md:col-span-2 flex items-center p-4 bg-gray-50 rounded-lg">
                    <input type="checkbox" x-model="params.bot_checkin.use_ai" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <div class="ml-3">
                        <label class="text-sm font-medium text-gray-700">使用 AI 识别验证码</label>
                        <p class="text-xs text-gray-500">启用后将使用配置的 AI Provider (OpenAI/Gemini/Claude) 自动识别图片验证码</p>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">成功关键词</label>
                    <input type="text" x-model="params.bot_checkin.success_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="签到成功,获得,积分">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
            </div>
        </div>

        <!-- Button Checkin Config -->
        <div x-show="form.type === 'button_checkin'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-cursor-line mr-2 text-indigo-500"></i>按钮签到配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">触发命令</label>
                    <input type="text" x-model="params.button_checkin.trigger_command"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="/start">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">按钮文本</label>
                    <input type="text" x-model="params.button_checkin.button_text"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="签到">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">成功关键词</label>
                    <input type="text" x-model="params.button_checkin.success_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
            </div>
        </div>

        <!-- Send Message Config -->
        <div x-show="form.type === 'send_message'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-message-3-line mr-2 text-indigo-500"></i>消息发送配置
                </h4>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">发送内容</label>
                    <textarea x-model="params.send_message.message" rows="3"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2.5"
                        placeholder="Hello World"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" x-model="params.send_message.wait_for_reply" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label class="ml-3 block text-sm font-medium text-gray-700">等待回复</label>
                </div>
            </div>
        </div>

        <!-- Submit Bar -->
        <div class="flex items-center justify-between pt-4">
            <div class="flex items-center">
                <input type="checkbox" x-model="form.enabled" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label class="ml-3 block text-sm font-medium text-gray-900">立即启用此任务</label>
            </div>
            <div class="flex space-x-3">
                <a href="/" class="inline-flex justify-center py-2.5 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    取消
                </a>
                <button type="submit" class="inline-flex justify-center py-2.5 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    保存任务
                </button>
            </div>
        </div>

    </form>
</div>

<script>
function taskForm() {
    return {
        isEdit: {{ 'true' if task else 'false' }},
        taskId: {{ task.id if task else 'null' }},
        form: {
            name: {{ (task.name if task else '') | tojson }},
            type: {{ (task.type if task else 'bot_checkin') | tojson }},
            account_id: {{ (task.account_id | string if task else '') | tojson }},
            target: {{ (task.target if task else '') | tojson }},
            schedule_cron: {{ (task.schedule_cron if task else '0 9 * * *') | tojson }},
            timezone: {{ (task.timezone if task else 'Asia/Shanghai') | tojson }},
            retries: {{ task.retries if task else 0 }},
            max_runtime_seconds: {{ task.max_runtime_seconds if task else 120 }},
            jitter_seconds: {{ task.jitter_seconds if task else 0 }},
            enabled: {{ 'true' if (not task or task.enabled) else 'false' }}
        },
        params: {
            bot_checkin: {
                command: {{ (task.params.command if task and task.params else '/checkin') | tojson }},
                timeout: {{ task.params.timeout if task and task.params else 60 }},
                use_ai: {{ 'true' if (task and task.params and task.params.use_ai) else 'false' }},
                success_keywords: {{ (','.join(task.params.success_patterns.keywords) if task and task.params and task.params.success_patterns else '签到成功,成功签到,获得,积分,恭喜,完成签到') | tojson }}
            },
            button_checkin: {
                trigger_command: {{ (task.params.trigger_command if task and task.params else '/start') | tojson }},
                button_text: {{ (task.params.button_text if task and task.params else '签到') | tojson }},
                success_keywords: {{ (','.join(task.params.success_keywords) if task and task.params and task.params.success_keywords else '签到成功,成功,获得,积分,恭喜,完成,米币') | tojson }}
            },
            send_message: {
                message: {{ (task.params.message if task and task.params else '') | tojson }},
                wait_for_reply: {{ 'true' if (task and task.params and task.params.wait_for_reply) else 'false' }}
            }
        },

        async submitForm() {
            if (!this.form.account_id) {
                showToast('请选择关联账号', 'error');
                return;
            }

            let finalParams = {};
            if (this.form.type === 'bot_checkin') {
                const p = this.params.bot_checkin;
                finalParams = {
                    command: p.command,
                    timeout: p.timeout,
                    use_ai: p.use_ai,
                    captcha_has_image: true,
                    captcha_has_buttons: true,
                    success_patterns: { keywords: p.success_keywords.split(',').map(s=>s.trim()).filter(s=>s) },
                    already_checked_patterns: { keywords: ["今天已签到", "已经签到", "今日已签到", "已签到", "重复签到"] },
                    fail_patterns: { keywords: ["失败", "错误", "验证码错误", "回答错误", "超时", "过期", "无效"] },
                    ignore_patterns: { keywords: ["会话已取消", "没有活跃的会话"] },
                    account_error_patterns: { keywords: ["黑名单", "封禁", "禁止", "未注册", "不存在", "未绑定"] }
                };
            } else if (this.form.type === 'button_checkin') {
                const p = this.params.button_checkin;
                finalParams = {
                    trigger_command: p.trigger_command,
                    button_text: p.button_text,
                    success_keywords: p.success_keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    already_checked_keywords: ["已签到", "已经签到", "今天已", "重复"],
                    fail_keywords: ["失败", "错误", "无效"],
                    timeout: 30
                };
            } else if (this.form.type === 'send_message') {
                finalParams = {
                    message: this.params.send_message.message,
                    wait_for_reply: this.params.send_message.wait_for_reply,
                    timeout: 30
                };
            }

            const payload = {
                ...this.form,
                account_id: parseInt(this.form.account_id),
                params: finalParams
            };

            const url = this.taskId ? '/api/v1/tasks/' + this.taskId : '/api/v1/tasks';
            const method = this.taskId ? 'PATCH' : 'POST';

            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (resp.ok) {
                    showToast('保存成功');
                    setTimeout(() => window.location.href = '/', 500);
                } else {
                    const err = await resp.json();
                    showToast('保存失败: ' + (err.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('网络错误', 'error');
            }
        }
    }
}
</script>
{% endblock %}
