{% extends "base.html" %}

{% block header_title %}{{ '编辑任务' if task else '新建任务' }}{% endblock %}

{% block title %}{{ '编辑任务' if task else '新建任务' }} - EmbyCheckin{% endblock %}

{% block head_scripts %}
<script>
function taskForm() {
    return {
        isEdit: {{ 'true' if task else 'false' }},
        taskId: {{ task.id if task else 'null' }},
        form: {
            name: {{ (task.name if task else '') | tojson }},
            type: {{ (task.type if task else 'bot_checkin') | tojson }},
            account_id: {{ (task.account_id | string if task else '') | tojson }},
            target: {{ (task.target if task else '') | tojson }},
            schedule_cron: {{ (task.schedule_cron if task else '0 9 * * *') | tojson }},
            timezone: {{ (task.timezone if task else 'Asia/Shanghai') | tojson }},
            retries: {{ task.retries if task else 0 }},
            max_runtime_seconds: {{ task.max_runtime_seconds if task else 120 }},
            jitter_seconds: {{ task.jitter_seconds if task else 0 }},
            enabled: {{ 'true' if (not task or task.enabled) else 'false' }}
        },
        params: {
            bot_checkin: {
                command: {{ (task.params.command if task and task.params and task.type == 'bot_checkin' else '/checkin') | tojson }},
                timeout: {{ task.params.timeout if task and task.params and task.type == 'bot_checkin' else 60 }},
                use_ai: {{ 'true' if (task and task.params and task.type == 'bot_checkin' and task.params.use_ai) else 'false' }},
                success_keywords: {{ (','.join(task.params.success_patterns.keywords) if task and task.params and task.type == 'bot_checkin' and task.params.success_patterns else '签到成功,成功签到,获得,积分,恭喜,完成签到') | tojson }}
            },
            button_checkin: {
                trigger_command: {{ (task.params.trigger_command if task and task.params and task.type == 'button_checkin' else '/start') | tojson }},
                button_text: {{ (task.params.button_text if task and task.params and task.type == 'button_checkin' else '签到') | tojson }},
                wait_panel_seconds: {{ (task.params.get('wait_panel_seconds', 2.0) if task and task.params and task.type == 'button_checkin' else 2.0) }},
                success_keywords: {{ (','.join(task.params.success_keywords) if task and task.params and task.type == 'button_checkin' and task.params.success_keywords else '签到成功,成功,获得,积分,恭喜,完成,米币') | tojson }},
                already_checked_keywords: {{ (','.join(task.params.already_checked_keywords) if task and task.params and task.type == 'button_checkin' and task.params.already_checked_keywords else '已签到,已经签到,今天已,重复,签到过了') | tojson }},
                fail_keywords: {{ (','.join(task.params.fail_keywords) if task and task.params and task.type == 'button_checkin' and task.params.fail_keywords else '失败,错误,无效') | tojson }}
            },
            send_message: {
                message: {{ (task.params.message if task and task.params and task.type == 'send_message' else '') | tojson }},
                wait_for_reply: {{ 'true' if (task and task.params and task.type == 'send_message' and task.params.wait_for_reply) else 'false' }}
            },
            emby_keepalive: {
                server_url: {{ ((task.params.get('server_url') or '') if task and task.params and task.type == 'emby_keepalive' else '') | tojson }},
                username: {{ ((task.params.get('username') or '') if task and task.params and task.type == 'emby_keepalive' else '') | tojson }},
                password: {{ ((task.params.get('password') or '') if task and task.params and task.type == 'emby_keepalive' else '') | tojson }},
                api_key: {{ ((task.params.get('api_key') or '') if task and task.params and task.type == 'emby_keepalive' else '') | tojson }},
                proxy_urls: {{ ('\n'.join(task.params.get('proxy_urls', [])) if task and task.params and task.type == 'emby_keepalive' and task.params.get('proxy_urls') else (task.params.get('proxy_url', '') if task and task.params and task.type == 'emby_keepalive' else '')) | tojson }},
                proxy_test_url: {{ (task.params.get('proxy_test_url', 'https://www.google.com') if task and task.params and task.type == 'emby_keepalive' else 'https://www.google.com') | tojson }},
                proxy_test_timeout: {{ task.params.get('proxy_test_timeout', 5) if task and task.params and task.type == 'emby_keepalive' else 5 }},
                play_duration: {{ task.params.get('play_duration', 120) if task and task.params and task.type == 'emby_keepalive' else 120 }},
                verify_ssl: {{ 'true' if (not task or task.type != 'emby_keepalive' or not task.params or task.params.get('verify_ssl', True) != False) else 'false' }}
            },
            exam_assistant: {
                keywords: {{ (','.join(task.params.keywords) if task and task.params and task.type == 'exam_assistant' and task.params.keywords else '考核,题目,问答,答题,quiz,考试') | tojson }},
                exclude_keywords: {{ (','.join(task.params.exclude_keywords) if task and task.params and task.type == 'exam_assistant' and task.params.exclude_keywords else '答案,正确') | tojson }},
                lookback_seconds: {{ task.params.lookback_seconds if task and task.params and task.type == 'exam_assistant' else 300 }},
                max_messages: {{ task.params.max_messages if task and task.params and task.type == 'exam_assistant' else 30 }},
                ai_prompt_template: {{ (task.params.ai_prompt_template if task and task.params and task.type == 'exam_assistant' else '请直接回答以下问题,只给出答案,不需要解释:\n\n{question}') | tojson }},
                auto_reply: {{ 'true' if (task and task.params and task.type == 'exam_assistant' and task.params.auto_reply) else 'false' }}
            }
        },

        async submitForm() {
            if (this.form.type !== 'emby_keepalive' && !this.form.account_id) {
                showToast('请选择关联账号', 'error');
                return;
            }

            if (this.form.type === 'emby_keepalive' && !this.params.emby_keepalive.server_url) {
                showToast('请填写 Emby 服务器地址', 'error');
                return;
            }

            let finalParams = {};
            if (this.form.type === 'bot_checkin') {
                const p = this.params.bot_checkin;
                finalParams = {
                    command: p.command,
                    timeout: p.timeout,
                    use_ai: p.use_ai,
                    captcha_has_image: true,
                    captcha_has_buttons: true,
                    success_patterns: { keywords: p.success_keywords.split(',').map(s=>s.trim()).filter(s=>s) },
                    already_checked_patterns: { keywords: ["今天已签到", "已经签到", "今日已签到", "已签到", "重复签到"] },
                    fail_patterns: { keywords: ["失败", "错误", "验证码错误", "回答错误", "超时", "过期", "无效"] },
                    ignore_patterns: { keywords: ["会话已取消", "没有活跃的会话"] },
                    account_error_patterns: { keywords: ["黑名单", "封禁", "禁止", "未注册", "不存在", "未绑定"] }
                };
            } else if (this.form.type === 'button_checkin') {
                const p = this.params.button_checkin;
                finalParams = {
                    trigger_command: p.trigger_command,
                    button_text: p.button_text,
                    wait_panel_seconds: p.wait_panel_seconds || 2.0,
                    success_keywords: p.success_keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    already_checked_keywords: p.already_checked_keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    fail_keywords: p.fail_keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    timeout: 30
                };
            } else if (this.form.type === 'send_message') {
                finalParams = {
                    message: this.params.send_message.message,
                    wait_for_reply: this.params.send_message.wait_for_reply,
                    timeout: 30
                };
            } else if (this.form.type === 'emby_keepalive') {
                const p = this.params.emby_keepalive;
                const proxyUrls = p.proxy_urls ? p.proxy_urls.split('\n').map(s=>s.trim()).filter(s=>s) : null;
                finalParams = {
                    server_url: p.server_url,
                    username: p.username || null,
                    password: p.password || null,
                    api_key: p.api_key || null,
                    proxy_urls: proxyUrls && proxyUrls.length > 0 ? proxyUrls : null,
                    proxy_test_url: p.proxy_test_url || 'https://www.google.com',
                    proxy_test_timeout: p.proxy_test_timeout || 5,
                    play_duration: p.play_duration,
                    verify_ssl: p.verify_ssl
                };
            } else if (this.form.type === 'exam_assistant') {
                const p = this.params.exam_assistant;
                finalParams = {
                    keywords: p.keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    exclude_keywords: p.exclude_keywords.split(',').map(s=>s.trim()).filter(s=>s),
                    lookback_seconds: p.lookback_seconds,
                    max_messages: p.max_messages,
                    ai_prompt_template: p.ai_prompt_template,
                    auto_reply: p.auto_reply
                };
            }

            const payload = {
                ...this.form,
                account_id: this.form.account_id ? parseInt(this.form.account_id) : null,
                target: this.form.target || null,
                params: finalParams
            };

            const url = this.taskId ? '/api/v1/tasks/' + this.taskId : '/api/v1/tasks';
            const method = this.taskId ? 'PATCH' : 'POST';

            try {
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    showToast('保存成功');
                    setTimeout(() => window.location.href = '/', 500);
                } else {
                    const err = await resp.json();
                    showToast('保存失败: ' + (err.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showToast('网络错误', 'error');
            }
        }
    }
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="taskForm()">

    <div class="mb-8 flex items-center justify-between">
        <div>
            <h3 class="text-2xl font-bold text-slate-800 tracking-tight">{{ '编辑任务' if task else '新建任务' }}</h3>
            <p class="text-sm text-slate-500 mt-1">配置定时任务的基本信息和执行参数</p>
        </div>
        <a href="/" class="text-slate-500 hover:text-slate-700 font-medium text-sm flex items-center bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm transition-all hover:shadow-md">
            <i class="ri-close-circle-line text-lg mr-1.5"></i>取消
        </a>
    </div>

    <form @submit.prevent="submitForm" class="space-y-6">

        <!-- 基础配置 -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-indigo-50/50 to-transparent">
                <h4 class="text-base font-bold text-slate-800 flex items-center">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center mr-3">
                        <i class="ri-settings-3-line text-indigo-600"></i>
                    </div>
                    基础配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-1">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">任务名称</label>
                    <input type="text" x-model="form.name" required
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md"
                        placeholder="例如：Emby 每日签到">
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">任务类型</label>
                    <select x-model="form.type" required :disabled="isEdit"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md bg-white font-medium text-slate-700">
                        {% for t in task_types %}
                        <option value="{{ t }}" class="py-2">
                            {% if t == 'bot_checkin' %}🤖 机器人签到 (bot_checkin)
                            {% elif t == 'button_checkin' %}🔘 按钮签到 (button_checkin)
                            {% elif t == 'send_message' %}💬 消息发送 (send_message)
                            {% elif t == 'emby_keepalive' %}💚 Emby保活 (emby_keepalive)
                            {% elif t == 'exam_assistant' %}🎓 考核辅助 (exam_assistant)
                            {% else %}{{ t }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">
                        关联账号
                        <span x-show="form.type !== 'emby_keepalive'" class="text-rose-500">*</span>
                        <span x-show="form.type === 'emby_keepalive'" class="text-slate-400 text-xs font-normal">(可选)</span>
                    </label>
                    <select x-model="form.account_id" :required="form.type !== 'emby_keepalive'"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md font-medium text-slate-700">
                        <option value="" class="text-slate-400">-- 选择账号 --</option>
                        {% for acc in accounts %}
                        <option value="{{ acc.id }}" class="py-2">👤 {{ acc.name }} · {{ acc.session_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">
                        目标对象 (Bot/Chat)
                        <span x-show="form.type !== 'emby_keepalive'" class="text-rose-500">*</span>
                        <span x-show="form.type === 'emby_keepalive'" class="text-slate-400 text-xs font-normal">(可选)</span>
                    </label>
                    <div class="relative rounded-xl shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span class="text-slate-500 sm:text-sm font-medium">@</span>
                        </div>
                        <input type="text" x-model="form.target" :required="form.type !== 'emby_keepalive'"
                            class="w-full pl-9 rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md"
                            placeholder="EmbyPublicBot">
                    </div>
                </div>
            </div>
        </div>

        <!-- 调度配置 -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-blue-50/50 to-transparent">
                <h4 class="text-base font-bold text-slate-800 flex items-center">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3">
                        <i class="ri-time-line text-blue-600"></i>
                    </div>
                    调度配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-6 gap-6">
                <div class="col-span-1 md:col-span-3">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Cron 表达式</label>
                    <input type="text" x-model="form.schedule_cron" required
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 font-mono bg-slate-50 tracking-wide text-indigo-700 transition-shadow hover:shadow-md"
                        placeholder="0 9 * * *">
                    <p class="mt-2 text-xs text-slate-500 flex items-center">
                        <i class="ri-information-line mr-1"></i>
                        分 时 日 月 周 (例: 0 9 * * * 表示每天9点)
                    </p>
                </div>

                <div class="col-span-1 md:col-span-3">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">快捷选择</label>
                    <select @change="if($event.target.value) form.schedule_cron = $event.target.value"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md font-medium text-slate-700">
                        <option value="" class="text-slate-400">-- 选择预设 --</option>
                        <optgroup label="🌅 每日固定时间">
                            <option value="0 8 * * *" class="py-2">☀️ 早上 8:00 (0 8 * * *)</option>
                            <option value="0 9 * * *" class="py-2">☀️ 早上 9:00 (0 9 * * *)</option>
                            <option value="0 10 * * *" class="py-2">☀️ 早上 10:00 (0 10 * * *)</option>
                            <option value="0 12 * * *" class="py-2">🌤️ 中午 12:00 (0 12 * * *)</option>
                            <option value="0 18 * * *" class="py-2">🌆 傍晚 18:00 (0 18 * * *)</option>
                            <option value="0 22 * * *" class="py-2">🌙 晚上 22:00 (0 22 * * *)</option>
                        </optgroup>
                        <optgroup label="⏰ 定时执行">
                            <option value="0 */6 * * *" class="py-2">🔄 每6小时 (0 */6 * * *)</option>
                            <option value="0 */12 * * *" class="py-2">🔄 每12小时 (0 */12 * * *)</option>
                        </optgroup>
                        <optgroup label="📅 工作日">
                            <option value="0 9 * * 1-5" class="py-2">💼 工作日 9:00 (0 9 * * 1-5)</option>
                            <option value="0 18 * * 1-5" class="py-2">💼 工作日 18:00 (0 18 * * 1-5)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">时区</label>
                    <input type="text" x-model="form.timezone"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">重试次数</label>
                    <input type="number" x-model.number="form.retries" min="0"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">随机延迟 (秒)</label>
                    <input type="number" x-model.number="form.jitter_seconds" min="0"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">最大运行时间 (秒)</label>
                    <input type="number" x-model.number="form.max_runtime_seconds" min="1"
                        class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3 transition-shadow hover:shadow-md">
                    <p class="mt-2 text-xs text-slate-500 flex items-start">
                        <i class="ri-error-warning-line mr-1 mt-0.5 text-amber-500"></i>
                        <span>任务执行超过此时间将被强制终止。Emby 保活任务推荐设置为 播放时长+60 秒</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Bot Checkin Config -->
        <div x-show="form.type === 'bot_checkin'" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-robot-line mr-2 text-indigo-500"></i>机器人签到配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">签到命令</label>
                    <input type="text" x-model="params.bot_checkin.command"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="/checkin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">响应超时 (秒)</label>
                    <input type="number" x-model.number="params.bot_checkin.timeout"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                
                <div class="md:col-span-2 flex items-center p-4 bg-gray-50 rounded-lg">
                    <input type="checkbox" x-model="params.bot_checkin.use_ai" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <div class="ml-3">
                        <label class="text-sm font-medium text-gray-700">使用 AI 识别验证码</label>
                        <p class="text-xs text-gray-500">启用后将使用配置的 AI Provider (OpenAI/Gemini/Claude) 自动识别图片验证码</p>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">成功关键词</label>
                    <input type="text" x-model="params.bot_checkin.success_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="签到成功,获得,积分">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
            </div>
        </div>

        <!-- Button Checkin Config -->
        <div x-show="form.type === 'button_checkin'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-cursor-line mr-2 text-indigo-500"></i>按钮签到配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">触发命令</label>
                    <input type="text" x-model="params.button_checkin.trigger_command"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="/start">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">按钮文本</label>
                    <input type="text" x-model="params.button_checkin.button_text"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="签到">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">等待面板延迟(秒)</label>
                    <input type="number" step="0.5" x-model.number="params.button_checkin.wait_panel_seconds"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="2.0">
                    <p class="mt-1 text-xs text-gray-500">发送命令后等待面板出现的时间,某些机器人需要更长时间(如10秒)</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">成功关键词</label>
                    <input type="text" x-model="params.button_checkin.success_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="签到成功,成功,获得,积分,恭喜,完成">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">已签到关键词</label>
                    <input type="text" x-model="params.button_checkin.already_checked_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="已签到,已经签到,今天已,重复,签到过了">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">失败关键词</label>
                    <input type="text" x-model="params.button_checkin.fail_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="失败,错误,无效">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
            </div>
        </div>

        <!-- Send Message Config -->
        <div x-show="form.type === 'send_message'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-message-3-line mr-2 text-indigo-500"></i>消息发送配置
                </h4>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">发送内容</label>
                    <textarea x-model="params.send_message.message" rows="3"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2.5"
                        placeholder="Hello World"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" x-model="params.send_message.wait_for_reply" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label class="ml-3 block text-sm font-medium text-gray-700">等待回复</label>
                </div>
            </div>
        </div>

        <!-- Emby KeepAlive Config -->
        <div x-show="form.type === 'emby_keepalive'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-heart-pulse-line mr-2 text-emerald-500"></i>Emby 保活配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Emby 服务器地址</label>
                    <input type="text" x-model="params.emby_keepalive.server_url"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="http://example.com:8096">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                    <input type="text" x-model="params.emby_keepalive.username"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="可选，使用 API Key 时留空">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" x-model="params.emby_keepalive.password"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="可选，使用 API Key 时留空">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="text" x-model="params.emby_keepalive.api_key"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="与用户名密码二选一">
                    <p class="mt-1 text-xs text-gray-500">可在 Emby 控制台 → 高级 → API 密钥 中创建</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        代理地址
                        <span class="text-xs text-gray-500 font-normal ml-1">(每行一个,支持多个,自动选择有效代理)</span>
                    </label>
                    <div class="relative flex border border-gray-300 rounded-lg shadow-sm focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500 overflow-hidden">
                        <div class="flex-none bg-slate-50 px-2 py-2.5 border-r border-gray-300 select-none">
                            <div x-data="{ lineCount: 3 }" class="text-xs font-mono text-slate-500 text-right leading-[1.4rem] space-y-0">
                                <template x-for="i in Math.max(3, (params.emby_keepalive.proxy_urls || '').split('\\n').length)" :key="i">
                                    <div x-text="i" class="h-[1.4rem]"></div>
                                </template>
                            </div>
                        </div>
                        <textarea x-model="params.emby_keepalive.proxy_urls" rows="3"
                            class="flex-1 border-0 focus:ring-0 sm:text-sm p-2.5 font-mono text-xs resize-y"
                            style="line-height: 1.4rem;"
                            placeholder="socks5://127.0.0.1:1080&#10;ss://method:password@server:port&#10;hysteria2://password@server:port?sni=example.com"></textarea>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">支持 http/socks5/ss/vless/hysteria2 协议,每行一个代理地址</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">代理测试URL</label>
                    <input type="text" x-model="params.emby_keepalive.proxy_test_url"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="https://www.google.com">
                    <p class="mt-1 text-xs text-gray-500">用于测试代理是否有效</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">代理测试超时 (秒)</label>
                    <input type="number" x-model.number="params.emby_keepalive.proxy_test_timeout" min="1" max="30"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模拟播放时长 (秒)</label>
                    <input type="number" x-model.number="params.emby_keepalive.play_duration" min="10"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div class="flex items-center pt-6">
                    <input type="checkbox" x-model="params.emby_keepalive.verify_ssl" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label class="ml-3 block text-sm font-medium text-gray-700">验证 SSL 证书</label>
                </div>
            </div>
        </div>

        <!-- Exam Assistant Config -->
        <div x-show="form.type === 'exam_assistant'" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-transition>
            <div class="px-6 py-4 border-b border-gray-50 bg-gray-50/50">
                <h4 class="text-base font-semibold text-gray-800 flex items-center">
                    <i class="ri-graduation-cap-line mr-2 text-cyan-500"></i>考核辅助配置
                </h4>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">触发关键词</label>
                    <input type="text" x-model="params.exam_assistant.keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="考核,题目,问答">
                    <p class="mt-1 text-xs text-gray-500">多个关键词用逗号分隔</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">排除关键词</label>
                    <input type="text" x-model="params.exam_assistant.exclude_keywords"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5"
                        placeholder="答案,正确">
                    <p class="mt-1 text-xs text-gray-500">包含这些词的消息会被跳过</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">检查过去 (秒)</label>
                    <input type="number" x-model.number="params.exam_assistant.lookback_seconds" min="30"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">最大检查消息数</label>
                    <input type="number" x-model.number="params.exam_assistant.max_messages" min="1" max="100"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">AI 提示词模板</label>
                    <textarea x-model="params.exam_assistant.ai_prompt_template" rows="2"
                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2.5"
                        placeholder="请直接回答以下问题：{question}"></textarea>
                    <p class="mt-1 text-xs text-gray-500">{question} 会被替换为实际问题内容</p>
                </div>
                <div class="md:col-span-2 flex items-center p-4 bg-gray-50 rounded-lg">
                    <input type="checkbox" x-model="params.exam_assistant.auto_reply" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <div class="ml-3">
                        <label class="text-sm font-medium text-gray-700">自动回复答案</label>
                        <p class="text-xs text-gray-500">启用后将自动把 AI 生成的答案发送到群组</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Bar -->
        <div class="flex items-center justify-between pt-4">
            <div class="flex items-center">
                <input type="checkbox" x-model="form.enabled" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label class="ml-3 block text-sm font-semibold text-slate-800">立即启用此任务</label>
            </div>
            <div class="flex space-x-4">
                <a href="/" class="inline-flex items-center justify-center py-3 px-8 border border-slate-300 shadow-sm text-sm font-semibold rounded-xl text-slate-700 bg-white hover:bg-slate-50 transition-all hover:shadow-md">
                    <i class="ri-close-line mr-2"></i>取消
                </a>
                <button type="submit" class="inline-flex items-center justify-center py-3 px-8 border border-transparent shadow-md text-sm font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0">
                    <i class="ri-save-line mr-2"></i>保存任务
                </button>
            </div>
        </div>

    </form>
</div>
{% endblock %}
